<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Citas</title>
    <style>
      
    </style>
</head>
<body>
    <h1>Registrar Cita</h1>
    <form action="">
        <label for="cliente">Cliente:</label>
        <input type="text" id="cliente" list="clientes" oninput="buscarClientes(); buscarVehiculos();">
        <datalist id="clientes"></datalist>
    
        <label for="vehiculos">Vehículos:</label>
        <select id="listaVehiculos"></select>
    
        <label for="fecha">Fecha:</label>
        <input type="datetime-local" id="fecha">
    
        <button onclick="registrarCita()">Registrar Cita</button>
    
        <p id="mensaje"></p>
    </form>
   

    <script>
        async function buscarClientes() {
            const nombre = document.getElementById('cliente').value;
            const response = await fetch(`clientes.php?nombre=${nombre}`);
            const result = await response.json();

            const datalistClientes = document.getElementById('clientes');
            datalistClientes.innerHTML = '';

            if (result.mensaje) {
                alert(result.mensaje);
            } else {
                result.forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.nombre; 
                    datalistClientes.appendChild(option);
                });
            }
        }

        async function buscarVehiculos() {
            const nombre = document.getElementById('cliente').value;
            const response = await fetch(`vehiculos.php?nombre=${nombre}`);
            const result = await response.json();

            const listaVehiculos = document.getElementById('listaVehiculos');
            listaVehiculos.innerHTML = '';

            if (result.mensaje) {
                alert(result.mensaje);
            } else {
                result.forEach(vehiculo => {
                    const option = document.createElement('option');
                    option.value = vehiculo.id;
                    option.textContent = `${vehiculo.marca} ${vehiculo.modelo}`;
                    listaVehiculos.appendChild(option);
                });
            }
        }

        async function registrarCita() {
            const clienteNombre = document.getElementById('cliente').value;
            const vehiculoId = document.getElementById('listaVehiculos').value;
            const fecha = document.getElementById('fecha').value;

            const responseCliente = await fetch(`clientes.php?nombre=${clienteNombre}`);
            const clientes = await responseCliente.json();
            if (clientes.length === 0) {
                alert("No se encontró ningún cliente con ese nombre");
                return;
            }
            const clienteId = clientes[0].id;

            const response = await fetch('registrar_cita.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `clienteId=${clienteId}&vehiculoId=${vehiculoId}&fecha=${fecha}`
            });

            const result = await response.json();
            document.getElementById('mensaje').textContent = result.mensaje;
        }
    </script>
</body>
</html>
